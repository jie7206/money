<h2><%= link_to t(:deal_record_index), deal_records_path %></h2>
<table>
  <tr class="thead">
    <td width="15"></td>
    <td><%= t(:deal_record_created) %></td>
    <td><%= t(:deal_record_price) %></td>
    <td><%= t(:deal_record_amount) %></td>
    <td><%= t(:exchange_to_cny) %></td>
    <td><%= t(:now_to_cny) %></td>
    <td><%= t(:earn_or_loss) %></td>
    <td><%= t(:profit_p) %></td>
    <td><%= t(:deal_record_earn_limit) %></td>
    <td><%= t(:deal_record_earn_short) %></td>
    <td><%= t(:updated_time) %></td>
    <td><%= t(:deal_record_real_profit) %></td>
  </tr>
<% n = 1 %>
<% if !@deal_records.empty? then price_now = @deal_records.first.price_now end %>
<%
total_price = total_amount = total_cny_amount = total_cny_amount_now =  total_earn_or_loss = total_earn_limit = total_real_profit = 0
btc_hold = DealRecord.btc_amount
%>
<% @deal_records.each do |dr| %>
  <% if n <= $deal_records_limit or params[:show_all] or params[:show_sell] %>
    <tr <%= change_row_color %>>
      <td align="right"><%= n %></td>
      <td><%= link_edit_to(dr,to_t(dr.created_at,true)) %></td>
      <td align="right"><%= price = to_n(dr.price) %></td>
      <td align="right"><%= amount = to_n(dr.amount,6) %></td>
      <td align="right"><%= cny_amount = to_n(dr.cny_amount,2) if !dr.real_profit %></td>
      <td align="right"><%= cny_amount_now = dr.cny_amount_now if !dr.real_profit%></td>
      <td align="right"><%= earn_or_loss = dr.earn_or_loss if !dr.real_profit %></td>
      <td align="right"><%= profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100) if !dr.real_profit %></td>
      <td align="right"><%= earn_limit = to_n(dr.earn_limit,3) if !dr.real_profit and dr.earn_limit > 0 %></td>
      <% earn_limit_price = dr.earn_limit_price %>
      <td align="right" <%= if_red_bg(price_now,earn_limit_price) if !dr.real_profit %>>
        <% if !dr.real_profit and (!dr.order_id or dr.order_id.empty?) %>
          <%= huobi_order_link(earn_limit_price,dr,'earn') %>
        <% end %>
      </td>
      <td align="right"><%= to_time(dr.updated_at) %></td>
      <td align="right"><%= real_profit = to_n(dr.real_profit,4) if dr.real_profit %></td>
    </tr>
  <%
    else
      price = to_n(dr.price)
      amount = to_n(dr.amount,6)
      cny_amount = to_n(dr.cny_amount,2) if !dr.real_profit
      cny_amount_now = dr.cny_amount_now if !dr.real_profit
      earn_or_loss = dr.earn_or_loss if !dr.real_profit
      profit = to_n(earn_or_loss.to_f/cny_amount.to_f*100) if !dr.real_profit
      earn_limit = to_n(dr.earn_limit,3) if !dr.real_profit and dr.earn_limit > 0
      real_profit = to_n(dr.real_profit,4) if dr.real_profit
     end
  %>
  <% n += 1 %>
  <% total_price += price.to_f * amount.to_f
     total_amount += amount.to_f
     total_cny_amount += cny_amount.to_f if !dr.real_profit
     total_cny_amount_now += cny_amount_now.to_f if !dr.real_profit
     total_earn_or_loss += earn_or_loss.to_f if !dr.real_profit
     total_earn_limit += earn_limit.to_f if !dr.real_profit
     total_real_profit += real_profit.to_f if dr.real_profit
  %>
<% end %>
  <tr class="thead">
    <td colspan="2">
      <% if !@deal_records.empty? %>
        <%= t(:price_now) %>: <%= kline_chart_link(to_n(price_now)) %>
      <% end %>
    </td>
    <td align="right"><%= to_n(DealRecord.ave_cost) if total_amount > 0 %></td>
    <td align="right"><%= link_to to_n(DealRecord.btc_amount,6), place_order_form_path(sell_all:1) %></td>
    <td align="right"><%= to_n(total_cny_amount) if !params[:show_sell] %></td>
    <td align="right"><%= to_n(total_cny_amount_now) if !params[:show_sell] %></td>
    <td align="right"><%= link_to to_n(DealRecord.profit_cny), place_order_form_path(sell_all:1) if !params[:show_sell] %></td>
    <td align="right"><%= to_n(total_earn_or_loss.to_f/total_cny_amount.to_f*100) if !params[:show_sell] %></td>
    <td align="right"><%= to_n(total_earn_limit,3) if !params[:show_sell] %></td>
    <td colspan="3" align="right"><%= to_n(DealRecord.total_real_profit,4) %></td>
  </tr>
</table>
<br/>
<%= link_to t(:update_deal_record), update_deal_records_path, { id: 'update_deal_records' } %>
| <%= link_to t(:show_sell_deal_records), deal_records_path(show_sell:1) %>
| <%= link_to t(:show_all_deal_records), deal_records_path(show_all:1) %>
| <%= link_to t(:zip_sell_deal_records), zip_sell_records_path %>
<%= update_btc_huobi_portfolios_link %>
| <%= link_to t(:clear_deal_records), clear_deal_records_path, { id: 'clear_deal_records' } %>
<p/></p>
